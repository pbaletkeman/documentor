name: Release Java 21

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (semver format: x.y.z)"
        required: true
        type: string
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+-java21"

permissions:
  contents: write
  packages: write

jobs:
  validate-version:
    name: Validate Version Format
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      tag: ${{ steps.extract.outputs.tag }}
    steps:
      - name: Extract and validate version
        id: extract
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"
          VERSION="${VERSION%-java21}"
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: x.y.z (e.g., 1.0.0)"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION-java21" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

  build-release:
    name: Build Java 21 Release
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Run tests
        run: ./gradlew testUnit
        continue-on-error: true

      - name: Generate JAR artifact
        run: ./gradlew bootJar

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentor-java21-jar
          path: build/libs/documentor.jar
          retention-days: 30

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-java21
          path: build/reports/
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [validate-version, build-release]
    runs-on: ubuntu-latest
    outputs:
      upload-url: ${{ steps.create-release.outputs.upload_url }}
      release-id: ${{ steps.create-release.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Create Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-version.outputs.tag }}
          release_name: Release ${{ needs.validate-version.outputs.tag }} (Java 21)
          body: |
            # Documentor ${{ needs.validate-version.outputs.tag }}

            ## ☕ Java 21 Release

            This release is built with **Java 21** featuring the latest language enhancements.

            ### Requirements
            - Java 21 or higher
            - Gradle 9.1.0 or higher

            ### Java 21 Features Used
            - **Virtual Threads** - Lightweight concurrency for improved performance
            - **Pattern Matching** - Enhanced switch expressions with pattern matching
            - **Sequenced Collections** - New collection interfaces for ordered access
            - **Record Patterns** - Destructuring for record types

            ## Release Artifacts
            - **documentor-java21.jar** - Executable Spring Boot application JAR (Java 21)

            ## Installation
            ```bash
            # Download the JAR
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.validate-version.outputs.tag }}/documentor-java21.jar

            # Run the application
            java -jar documentor-java21.jar
            ```

            ## Docker
            ```bash
            docker build -t documentor:java21 .
            docker run --rm documentor:java21 --help
            ```

            ## Configuration
            See [Configuration Guide](https://github.com/${{ github.repository }}/blob/main/docs/CONFIGURATION.md)

            ## Documentation
            - [Getting Started](https://github.com/${{ github.repository }}/blob/main/docs/GETTING_STARTED.md)
            - [Usage Examples](https://github.com/${{ github.repository }}/blob/main/docs/USAGE_EXAMPLES.md)

            ---
            **Java Version:** 21
            **Branch:** main
            **Commit:** ${{ github.sha }}
          draft: false
          prerelease: false

  upload-artifacts:
    name: Upload Release Artifacts
    needs: [validate-version, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: documentor-java21-jar
          path: ./artifacts

      - name: Rename JAR for Java 21
        run: mv ./artifacts/documentor.jar ./artifacts/documentor-java21.jar

      - name: Upload JAR to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload-url }}
          asset_path: ./artifacts/documentor-java21.jar
          asset_name: documentor-java21.jar
          asset_content_type: application/java-archive

      - name: Generate checksums
        run: |
          cd ./artifacts
          sha256sum documentor-java21.jar > documentor-java21.jar.sha256
          echo "SHA256 Checksum:"
          cat documentor-java21.jar.sha256

      - name: Upload checksums to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload-url }}
          asset_path: ./artifacts/documentor-java21.jar.sha256
          asset_name: documentor-java21.jar.sha256
          asset_content_type: text/plain

  release-summary:
    name: Release Summary
    needs: [validate-version, upload-artifacts]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          # Release Summary: ${{ needs.validate-version.outputs.tag }}

          ## ☕ Java 21 Release

          | Property | Value |
          |----------|-------|
          | **Version** | ${{ needs.validate-version.outputs.tag }} |
          | **Java Version** | 21 |
          | **Branch** | main |
          | **Release URL** | https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-version.outputs.tag }} |
          | **Commit** | ${{ github.sha }} |
          | **Author** | ${{ github.actor }} |

          ## Build Status
          - ✅ Build: SUCCESS
          - ✅ Artifacts: UPLOADED

          ## Release Artifacts
          - `documentor-java21.jar` - Executable Spring Boot JAR (Java 21)
          - `documentor-java21.jar.sha256` - SHA256 checksum

          ## Java 21 Features
          - ✅ Virtual Threads
          - ✅ Pattern Matching
          - ✅ Sequenced Collections
          - ✅ Record Patterns

          ## Download Links
          - [Release Page](https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-version.outputs.tag }})
          - [documentor-java21.jar](https://github.com/${{ github.repository }}/releases/download/${{ needs.validate-version.outputs.tag }}/documentor-java21.jar)

          ## Getting Started
          ```bash
          # Download
          wget https://github.com/${{ github.repository }}/releases/download/${{ needs.validate-version.outputs.tag }}/documentor-java21.jar

          # Verify
          sha256sum -c documentor-java21.jar.sha256

          # Run
          java -jar documentor-java21.jar
          ```

          **Status:** ✅ Java 21 release completed successfully!
          EOF
