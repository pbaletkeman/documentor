name: Auto-create PR from labeled task

on:
  issues:
    types: [labeled]

jobs:
  create-pr-from-task:
    if: contains(github.event.issue.labels.*.name, 'start-work')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          BRANCH_NAME="work/issue-${{ env.ISSUE_NUMBER }}-task"
          git checkout -b $BRANCH_NAME
          echo "BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Start work for issue #${{ github.event.issue.number }}"
          title: "WIP: Start work for issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
          body: |
            ## Issue
            Closes #${{ github.event.issue.number }}

            ## PRD Reference
            See `.github/file-named-prd.md` for full requirements.

            ## Work Started
            This PR begins work on the task outlined in issue #${{ github.event.issue.number }}.

            **Issue Details:**
            ${{ github.event.issue.body }}

            ## Checklist
            - [ ] Implementation complete
            - [ ] Unit tests passing
            - [ ] Integration tests passing
            - [ ] Documentation updated
            - [ ] Code review completed
            - [ ] Ready for merge

          base: main
          branch: ${{ env.BRANCH }}
          delete-branch: false

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… **Work started!** A PR has been created for this task. Watch the PR for progress updates and CI/CD status.`
            })

      - name: Add in-progress label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['in-progress']
            })
