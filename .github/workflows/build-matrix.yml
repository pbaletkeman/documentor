name: Build Matrix

on:
  push:
    branches:
      - main
      - develop
      - java-17-lts
  pull_request:
    branches:
      - main
      - develop
      - java-17-lts

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
      fail-fast: false

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Java version
        id: java-version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/java-17-lts" ]]; then
            echo "version=17" >> $GITHUB_OUTPUT
          else
            echo "version=21" >> $GITHUB_OUTPUT
          fi

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ steps.java-version.outputs.version }}
          distribution: "temurin"
          cache: gradle

      - name: Run tests (Unit)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./gradlew.bat testUnit
          else
            ./gradlew testUnit
          fi

      - name: Run tests (All - including integration)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./gradlew.bat testAll
          else
            ./gradlew testAll
          fi

      - name: Build project
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./gradlew.bat build
          else
            ./gradlew build
          fi

      - name: Generate test report
        if: always()
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./gradlew.bat jacocoTestReport
          else
            ./gradlew jacocoTestReport
          fi

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && steps.java-version.outputs.version == '21'
        uses: codecov/codecov-action@v4
        with:
          file: ./build/reports/jacoco/test/jacocoTestReport.xml
          fail_ci_if_error: false

      - name: Upload JaCoCo coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report-${{ matrix.os }}-java${{ steps.java-version.outputs.version }}
          path: build/reports/jacoco/

      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report-${{ matrix.os }}-java${{ steps.java-version.outputs.version }}
          path: build/reports/checkstyle/

      - name: Comment PR with results
        if: |
          always() &&
          github.event_name == 'pull_request' &&
          matrix.os == 'ubuntu-latest'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let comment = '## Build Matrix Results\n\n';
            comment += 'âœ… **Build Status**\n';
            comment += '- OS: ${{ matrix.os }}\n';
            comment += '- Java: ${{ steps.java-version.outputs.version }}\n';
            comment += '- Branch: ${{ github.ref_name }}\n\n';

            if (fs.existsSync('build/reports/jacoco/test/html/index.html')) {
              comment += 'ðŸ“Š **Coverage Report**\n';
              comment += '- Report generated at: `build/reports/jacoco/test/html/index.html`\n\n';
            }

            comment += '**Artifacts**\n';
            comment += '- JaCoCo Coverage Report: [View](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
            comment += '- Checkstyle Report: [View](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
